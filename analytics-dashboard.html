<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Complaint System - Analytics Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; }
        
        .header { background: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header h1 { color: #6366f1; font-size: 24px; font-weight: 600; }
        .back-btn { background: #6366f1; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; }
        
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 48px; font-weight: bold; color: #6366f1; margin-bottom: 10px; }
        .stat-label { color: #6b7280; font-size: 16px; }
        .stat-icon { font-size: 24px; margin-bottom: 15px; }
        
        .charts-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        .chart-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-title { font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 20px; }
        
        .priority-chart { height: 200px; display: flex; align-items: end; gap: 20px; justify-content: center; }
        .bar { width: 40px; background: linear-gradient(to top, #6366f1, #06b6d4); border-radius: 4px 4px 0 0; position: relative; }
        .bar-label { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 12px; color: #6b7280; }
        .bar-value { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: bold; color: #374151; }
        
        .category-chart { height: 200px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .category-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f3f4f6; border-radius: 20px; }
        .category-dot { width: 12px; height: 12px; border-radius: 50%; }
        .category-text { font-size: 14px; color: #374151; }
        
        .recent-tickets { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .ticket-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #e5e7eb; }
        .ticket-info { display: flex; flex-direction: column; gap: 4px; }
        .ticket-id { font-weight: 600; color: #374151; }
        .ticket-desc { color: #6b7280; font-size: 14px; }
        .priority-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .priority-critical { background: #fee2e2; color: #dc2626; }
        .priority-high { background: #fef3c7; color: #d97706; }
        .priority-medium { background: #dbeafe; color: #2563eb; }
        .priority-low { background: #d1fae5; color: #059669; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Analytics Dashboard</h1>
        <a href="/dashboard" class="back-btn">‚Üê Back to Dashboard</a>
    </div>
    
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üé´</div>
                <div class="stat-number" id="totalTickets">0</div>
                <div class="stat-label">Total Tickets</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-number" id="resolvedTickets">0</div>
                <div class="stat-label">Resolved</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-number" id="avgResponseTime">< 1h</div>
                <div class="stat-label">Avg Response Time</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-number" id="satisfactionRate">98%</div>
                <div class="stat-label">Satisfaction Rate</div>
            </div>
        </div>
        
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-title">Tickets by Priority</div>
                <div class="priority-chart">
                    <div class="bar" style="height: 120px;" id="criticalBar">
                        <div class="bar-value" id="criticalCount">0</div>
                        <div class="bar-label">Critical</div>
                    </div>
                    <div class="bar" style="height: 80px;" id="highBar">
                        <div class="bar-value" id="highCount">0</div>
                        <div class="bar-label">High</div>
                    </div>
                    <div class="bar" style="height: 100px;" id="mediumBar">
                        <div class="bar-value" id="mediumCount">0</div>
                        <div class="bar-label">Medium</div>
                    </div>
                    <div class="bar" style="height: 60px;" id="lowBar">
                        <div class="bar-value" id="lowCount">0</div>
                        <div class="bar-label">Low</div>
                    </div>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">Tickets by Category</div>
                <div class="category-chart" id="categoryChart">
                    <div class="category-item">
                        <div class="category-dot" style="background: #6366f1;"></div>
                        <div class="category-text">Hardware (<span id="hardwareCount">0</span>)</div>
                    </div>
                    <div class="category-item">
                        <div class="category-dot" style="background: #06b6d4;"></div>
                        <div class="category-text">Software (<span id="softwareCount">0</span>)</div>
                    </div>
                    <div class="category-item">
                        <div class="category-dot" style="background: #10b981;"></div>
                        <div class="category-text">Network (<span id="networkCount">0</span>)</div>
                    </div>
                    <div class="category-item">
                        <div class="category-dot" style="background: #f59e0b;"></div>
                        <div class="category-text">Login (<span id="loginCount">0</span>)</div>
                    </div>
                    <div class="category-item">
                        <div class="category-dot" style="background: #ef4444;"></div>
                        <div class="category-text">Performance (<span id="performanceCount">0</span>)</div>
                    </div>
                    <div class="category-item">
                        <div class="category-dot" style="background: #8b5cf6;"></div>
                        <div class="category-text">Other (<span id="otherCount">0</span>)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="recent-tickets">
            <div class="chart-title">Recent Tickets</div>
            <div id="recentTicketsList">
                <div style="text-align: center; color: #6b7280; padding: 40px;">
                    No tickets yet
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadAnalytics() {
            try {
                const response = await fetch('/api/tickets');
                const tickets = await response.json();
                
                updateStats(tickets);
                updateCharts(tickets);
                updateRecentTickets(tickets);
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }
        
        function updateStats(tickets) {
            const total = tickets.length;
            const resolved = tickets.filter(t => t.status === 'Resolved').length;
            
            document.getElementById('totalTickets').textContent = total;
            document.getElementById('resolvedTickets').textContent = resolved;
        }
        
        function updateCharts(tickets) {
            // Priority counts
            const priorityCounts = {
                'Critical': 0,
                'High': 0,
                'Medium': 0,
                'Low': 0
            };
            
            // Category counts
            const categoryCounts = {
                'Hardware': 0,
                'Software': 0,
                'Network': 0,
                'Login': 0,
                'Performance': 0,
                'Other': 0
            };
            
            tickets.forEach(ticket => {
                // Skip test documents
                if (ticket._id === 'startup-test') return;
                
                const priority = ticket.priority || 'Medium';
                const category = ticket.category || 'Other';
                
                if (priorityCounts.hasOwnProperty(priority)) {
                    priorityCounts[priority]++;
                }
                if (categoryCounts.hasOwnProperty(category)) {
                    categoryCounts[category]++;
                }
            });
            
            // Update priority chart
            document.getElementById('criticalCount').textContent = priorityCounts.Critical;
            document.getElementById('highCount').textContent = priorityCounts.High;
            document.getElementById('mediumCount').textContent = priorityCounts.Medium;
            document.getElementById('lowCount').textContent = priorityCounts.Low;
            
            // Update category chart
            document.getElementById('hardwareCount').textContent = categoryCounts.Hardware;
            document.getElementById('softwareCount').textContent = categoryCounts.Software;
            document.getElementById('networkCount').textContent = categoryCounts.Network;
            document.getElementById('loginCount').textContent = categoryCounts.Login;
            document.getElementById('performanceCount').textContent = categoryCounts.Performance;
            document.getElementById('otherCount').textContent = categoryCounts.Other;
        }
        
        function updateRecentTickets(tickets) {
            const professionOrder = { 'Doctor': 1, 'Engineer': 2, 'Manager': 3, 'Teacher': 4, 'Accountant': 5, 'HR': 6, 'Sales': 7, 'Developer': 8, 'Student': 9, 'Other': 10 };
            const priorityOrder = { 'Critical': 1, 'High': 2, 'Medium': 3, 'Low': 4 };
            
            const recentTickets = tickets
                .filter(ticket => ticket._id !== 'startup-test') // Exclude test document
                .sort((a, b) => {
                    const profA = professionOrder[a.profession] || 10;
                    const profB = professionOrder[b.profession] || 10;
                    
                    // First sort by profession
                    if (profA !== profB) {
                        return profA - profB;
                    }
                    
                    // Then sort by priority within same profession
                    const prioA = priorityOrder[a.priority] || 4;
                    const prioB = priorityOrder[b.priority] || 4;
                    
                    if (prioA !== prioB) {
                        return prioA - prioB;
                    }
                    
                    // Finally by creation date (newest first)
                    return new Date(b.createdAt) - new Date(a.createdAt);
                })
                .slice(0, 5);
            
            const ticketsList = document.getElementById('recentTicketsList');
            
            if (recentTickets.length === 0) {
                ticketsList.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">No tickets yet</div>';
                return;
            }
            
            ticketsList.innerHTML = recentTickets.map(ticket => {
                const ticketId = ticket.ticketId || ticket._id || 'N/A';
                const title = ticket.title || ticket.description || 'No description';
                const priority = ticket.priority || 'Medium';
                const createdDate = new Date(ticket.createdAt).toLocaleDateString();
                
                return `
                    <div class="ticket-row">
                        <div class="ticket-info">
                            <div class="ticket-id">${ticketId}</div>
                            <div class="ticket-desc">${title.substring(0, 50)}${title.length > 50 ? '...' : ''}</div>
                            <div style="font-size: 12px; color: #9ca3af;">üë• ${ticket.profession || 'N/A'} ‚Ä¢ ${createdDate}</div>
                        </div>
                        <div class="priority-badge priority-${priority.toLowerCase()}">
                            ${priority}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Load analytics on page load
        window.onload = loadAnalytics;
        
        // Refresh every 30 seconds
        setInterval(loadAnalytics, 30000);
    </script>
</body>
</html>